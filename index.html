<!DOCTYPE html>
<html lang="es">
<head>
    <!-- [TODOS LOS ESTILOS Y META TAGS PERMANECEN IGUALES] -->
    <!-- ... -->
</head>
<body>
    <!-- [TODO EL HTML PERMANECE IGUAL] -->
    <!-- ... -->

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAH4I4XbzqAph5yq9MUILtu118y5os-oJc",
            authDomain: "smilechat-8afea.firebaseapp.com",
            databaseURL: "https://smilechat-8afea-default-rtdb.firebaseio.com",
            projectId: "smilechat-8afea",
            storageBucket: "smilechat-8afea.firebasestorage.app",
            messagingSenderId: "88368495681",
            appId: "1:88368495681:web:bf70881957a0a819f81ac0",
            measurementId: "G-NKE2WRMT83"
        };

        // Configuración de Supabase
        const supabaseConfig = {
            url: 'https://mlbjdyedhmtnxzoctthq.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sYmpkeWVkaG10bnh6b2N0dGhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0OTEwNDAsImV4cCI6MjA2NTA2NzA0MH0.qyiMIofGCLearDUn5UnYU3y07U27iBlAZ-ET8KDe_Zc',
            bucket: 'chat-images'
        };

        // Inicialización de Firebase y Supabase
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Inicializar Firebase
                const firebaseApp = firebase.initializeApp(firebaseConfig);
                const database = firebase.database();
                const messagesRef = database.ref('messages');
                const typingRef = database.ref('typing');
                const presenceRef = database.ref('presence');

                // Inicializar Supabase
                const supabase = supabase.createClient(supabaseConfig.url, supabaseConfig.key);

                // [EL RESTO DEL CÓDIGO PERMANECE IGUAL HASTA LA FUNCIÓN setUsername]
                
                function setUsername() {
                    const newUsername = elements.usernameInput.value.trim();
                    
                    // Validaciones mejoradas
                    if (!newUsername) {
                        showNotification("Por favor ingresa un nombre válido", false);
                        return;
                    }
                    
                    if (newUsername.length > 20) {
                        showNotification("El nombre no puede tener más de 20 caracteres", false);
                        return;
                    }
                    
                    // Verificar si el nombre ya está en uso
                    presenceRef.child(newUsername).once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            showNotification("Este nombre ya está en uso. Por favor elige otro.", false);
                            return;
                        }
                        
                        // Si el nombre está disponible, continuar
                        username = newUsername;
                        elements.userInfo.textContent = `¡Hola, ${username}! Estás listo para chatear.`;
                        elements.usernameInput.disabled = true;
                        elements.setUsernameBtn.disabled = true;
                        elements.messageGroup.style.display = 'flex';
                        elements.messageInput.disabled = false;
                        elements.sendButton.disabled = false;
                        elements.messageInput.focus();
                        
                        // Configurar presencia
                        myPresenceRef = presenceRef.child(username);
                        myPresenceRef.set(true);
                        myPresenceRef.onDisconnect().remove();
                        
                        // Mensaje de sistema
                        messagesRef.push({
                            sender: 'Sistema',
                            content: `${username} se ha unido al chat.`,
                            type: 'system-message',
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                        
                        showNotification(`Bienvenido, ${username}!`);
                        requestNotificationPermission();
                    });
                }

                // [EL RESTO DEL CÓDIGO PERMANECE IGUAL]

            } catch (error) {
                console.error("Error de inicialización:", error);
                showNotification("Error al conectar con el servidor", false);
            }
        });

        // [EL RESTO DEL CÓDIGO PERMANECE IGUAL]
    </script>
</body>
</html>
