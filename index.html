<!DOCTYPE html>
<html lang="es">
<head>
    <!-- [Mantener todos los meta tags y estilos igual] -->
    <!-- ... -->
</head>
<body>
    <!-- [Mantener toda la estructura HTML igual] -->
    <!-- ... -->

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAH4I4XbzqAph5yq9MUILtu118y5os-oJc",
            authDomain: "smilechat-8afea.firebaseapp.com",
            databaseURL: "https://smilechat-8afea-default-rtdb.firebaseio.com",
            projectId: "smilechat-8afea",
            storageBucket: "smilechat-8afea.firebasestorage.app",
            messagingSenderId: "88368495681",
            appId: "1:88368495681:web:bf70881957a0a819f81ac0",
            measurementId: "G-NKE2WRMT83"
        };

        // Configuración de Supabase
        const supabaseConfig = {
            url: 'https://mlbjdyedhmtnxzoctthq.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sYmpkeWVkaG10bnh6b2N0dGhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0OTEwNDAsImV4cCI6MjA2NTA2NzA0MH0.qyiMIofGCLearDUn5UnYU3y07U27iBlAZ-ET8KDe_Zc',
            bucket: 'chat-images'
        };

        // Variables globales
        let username = '';
        let isTyping = false;
        let typingTimeout;
        let myPresenceRef;
        let myMessages = new Set();
        let isWindowFocused = true;
        let tempImageMessages = {};
        let database, messagesRef, typingRef, presenceRef, supabaseClient;

        // [Mantener todas las funciones auxiliares iguales]
        // ...

        // Función modificada para establecer nombre de usuario con manejo de errores
        function setUsername() {
            const newUsername = elements.usernameInput.value.trim();
            
            if (!newUsername) {
                showNotification("Por favor ingresa un nombre válido", false);
                return;
            }
            
            if (newUsername.length > 20) {
                showNotification("El nombre no puede tener más de 20 caracteres", false);
                return;
            }
            
            // Verificar si el nombre está disponible
            presenceRef.child(newUsername).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        showNotification("Este nombre ya está en uso. Por favor elige otro.", false);
                        return;
                    }
                    
                    username = newUsername;
                    elements.userInfo.textContent = `¡Hola, ${username}! Estás listo para chatear.`;
                    elements.usernameInput.disabled = true;
                    elements.setUsernameBtn.disabled = true;
                    elements.messageGroup.style.display = 'flex';
                    elements.messageInput.disabled = false;
                    elements.sendButton.disabled = false;
                    elements.messageInput.focus();
                    
                    // Configurar presencia con manejo de errores
                    myPresenceRef = presenceRef.child(username);
                    myPresenceRef.set(true)
                        .then(() => {
                            myPresenceRef.onDisconnect().remove()
                                .catch(e => console.error("Error al configurar onDisconnect:", e));
                        })
                        .catch(e => {
                            console.error("Error al establecer presencia:", e);
                            showNotification("Error al conectar. Intenta recargar la página.", false);
                        });
                    
                    // Enviar mensaje de sistema
                    messagesRef.push({
                        sender: 'Sistema',
                        content: `${username} se ha unido al chat.`,
                        type: 'system-message',
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).catch(e => console.error("Error al enviar mensaje de sistema:", e));
                    
                    showNotification(`Bienvenido, ${username}!`);
                    requestNotificationPermission();
                })
                .catch((error) => {
                    console.error("Error al verificar nombre de usuario:", error);
                    showNotification("Error al verificar nombre. Intenta otro nombre.", false);
                });
        }

        // Inicialización de la aplicación con manejo mejorado de errores
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Inicializar Firebase
                const firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                // Configurar referencias con manejo de errores
                try {
                    messagesRef = database.ref('messages');
                    typingRef = database.ref('typing');
                    presenceRef = database.ref('presence');
                    
                    // Verificar permisos
                    presenceRef.limitToLast(1).once('value')
                        .then(() => {
                            // Configurar listeners si los permisos son correctos
                            configureFirebaseListeners();
                            showNotification("Chat cargado correctamente");
                        })
                        .catch((error) => {
                            console.error("Error de permisos:", error);
                            handlePermissionError();
                        });
                    
                } catch (error) {
                    console.error("Error al configurar referencias:", error);
                    handlePermissionError();
                }

                // Inicializar Supabase
                supabaseClient = supabase.createClient(supabaseConfig.url, supabaseConfig.key);

                // Configurar event listeners del DOM
                configureDOMListeners();

            } catch (error) {
                console.error("Error de inicialización:", error);
                handleInitializationError();
            }
        });

        // Función para manejar errores de permisos
        function handlePermissionError() {
            elements.userInfo.textContent = "Error de permisos. Verifica las reglas de seguridad de Firebase.";
            elements.userInfo.style.backgroundColor = 'var(--warning)';
            showNotification("Error de permisos. No se puede acceder al chat.", false);
        }

        // Función para manejar errores de inicialización
        function handleInitializationError() {
            elements.userInfo.textContent = "Error al conectar con el servidor. Por favor recarga la página.";
            elements.userInfo.style.backgroundColor = 'var(--warning)';
            showNotification("Error de conexión. Recarga la página.", false);
        }

        // Función para configurar listeners de Firebase
        function configureFirebaseListeners() {
            // Listener para nuevos mensajes
            messagesRef.orderByChild('timestamp').on('child_added', (snapshot) => {
                const data = snapshot.val();
                const messageId = snapshot.key;
                
                if (data.sender !== username || data.type === 'system-message' || myMessages.has(messageId)) {
                    displayMessage(data, messageId, myMessages.has(messageId));
                    
                    if (data.sender !== username && !myMessages.has(messageId) && username) {
                        if (!isWindowFocused) {
                            showNewMessageNotification();
                        } else {
                            playNotificationSound();
                        }
                    }
                }
            });

            // Listener para usuarios escribiendo
            typingRef.on('child_added', (snapshot) => {
                if (snapshot.key !== username) {
                    showTypingIndicator(snapshot.key);
                }
            });

            typingRef.on('child_removed', (snapshot) => {
                if (snapshot.key !== username) {
                    hideTypingIndicator();
                }
            });
            
            // Listener para conteo de usuarios en línea
            presenceRef.on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const count = Object.keys(users).length;
                elements.onlineUsers.textContent = count;
            });
            
            // Eliminar mensajes antiguos cada hora
            deleteOldMessages();
            setInterval(deleteOldMessages, 3600000);
        }

        // Función para configurar listeners del DOM
        function configureDOMListeners() {
            elements.usernameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    setUsername();
                }
            });
            
            elements.setUsernameBtn.addEventListener('click', setUsername);
            
            elements.messageInput.addEventListener('input', function() {
                updateTypingStatus();
                adjustTextareaHeight(this);
            });
            
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            elements.sendButton.addEventListener('click', sendMessage);
            
            elements.emojiButton.addEventListener('click', () => {
                elements.emojiPicker.classList.toggle('show');
            });

            elements.emojiPicker.addEventListener('emoji-click', (event) => {
                elements.messageInput.value += event.detail.unicode;
                elements.messageInput.focus();
                adjustTextareaHeight(elements.messageInput);
            });

            document.addEventListener('click', (e) => {
                if (!elements.emojiButton.contains(e.target) && !elements.emojiPicker.contains(e.target)) {
                    elements.emojiPicker.classList.remove('show');
                }
            });

            elements.uploadButton.addEventListener('click', async () => {
                if (!username) {
                    showNotification("Primero ingresa tu nombre de usuario", false);
                    return;
                }

                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        await uploadPastedImage(file);
                    }
                };
                
                input.click();
            });

            elements.messageInput.addEventListener('paste', async (e) => {
                const items = (e.clipboardData || window.clipboardData).items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const blob = items[i].getAsFile();
                        await uploadPastedImage(blob);
                        return;
                    }
                }
            });

            // Limpiar al salir
            window.addEventListener('beforeunload', () => {
                if (username) {
                    typingRef.child(username).remove().catch(e => console.error("Error al limpiar typing:", e));
                    if (myPresenceRef) myPresenceRef.remove().catch(e => console.error("Error al limpiar presencia:", e));
                }
            });

            // Mostrar círculos de fondo
            document.querySelectorAll('.circle').forEach(circle => {
                circle.style.opacity = '0.5';
            });
        }

        // [Mantener el resto de las funciones iguales]
        // ...
    </script>
</body>
</html>
